<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/admin_dashboard.css') }}">
</head>
<body>
  <div class="container">
    <h1>Welcome, {{ user.name }} (Admin)</h1>

    <h2>All Users</h2>
    <ul class="user-list">
      {% for u in users %}
        <li>
          <span class="name">{{ u.name }}</span>
          <span class="email">{{ u.email }}</span>
          <span class="role">Role: {{ u.role }}</span>
        </li>
      {% else %}
        <li>No users found.</li>
      {% endfor %}
    </ul>

    <h2>Current Mentor Assignments</h2>
    <ul class="mentor-assignments">
      {% for student in students %}
        <li class="assignment-item">
          <div class="assignment-info">
            <strong>{{ student.name }}</strong>
            {% if student.mentor %}
              → Mentor: <strong>{{ student.mentor.name }}</strong>
              {% if latest_assignments[student.id] %}
                <br><small>Assigned on: {{ latest_assignments[student.id].assigned_at.strftime('%d %b %Y, %I:%M %p') }}</small>
              {% endif %}
            {% else %}
              → <em>No mentor assigned</em>
            {% endif %}
          </div>

          <div class="assignment-actions">
            {% if student.mentor %}
              <!-- Remove Mentor -->
              <form method="POST" action="{{ url_for('remove_mentor') }}">
                <input type="hidden" name="student_id" value="{{ student.id }}">
                <button type="submit" class="btn remove">Remove</button>
              </form>

              <!-- Reassign Mentor -->
              <form method="POST" action="{{ url_for('assign_mentor') }}">
                <input type="hidden" name="student_id" value="{{ student.id }}">
                <select name="mentor_id">
                  {% for mentor in mentors %}
                    <option value="{{ mentor.id }}" {% if student.mentor.id == mentor.id %}selected{% endif %}>
                      {{ mentor.name }}
                    </option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn">Re-Assign</button>
              </form>
            {% else %}
              <!-- Assign Mentor -->
              <form method="POST" action="{{ url_for('assign_mentor') }}">
                <input type="hidden" name="student_id" value="{{ student.id }}">
                <select name="mentor_id">
                  {% for mentor in mentors %}
                    <option value="{{ mentor.id }}">{{ mentor.name }}</option>
                  {% endfor %}
                </select>
                <button type="submit" class="btn">Assign</button>
              </form>
            {% endif %}

            {% if student.mentor %}
              <!-- ✅ View Chat Button -->
              <a class="btn view-chat" href="{{ url_for('admin_view_chat', student_id=student.id, mentor_id=student.mentor.id) }}">
                View Chat
              </a>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>

    <h2>Add User</h2>
    <form method="POST" action="{{ url_for('add_user') }}">
      <label for="name">Name:</label>
      <input type="text" name="name" required>

      <label for="email">Email:</label>
      <input type="email" name="email" required>

      <label for="password">Password:</label>
      <input type="password" name="password" required>

      <label for="role">Role:</label>
      <select name="role">
        <option value="student">Student</option>
        <option value="mentor">Mentor</option>
        <option value="admin">Admin</option>
      </select>

      <button type="submit" class="btn">Add User</button>
    </form>

    <h2>Remove User</h2>
    <form method="POST" action="{{ url_for('remove_user') }}">
      <label for="user_id">Select User:</label>
      <select name="user_id">
        {% for u in users %}
          <option value="{{ u.id }}">{{ u.name }} ({{ u.role }})</option>
        {% endfor %}
      </select>
      <button type="submit" class="btn">Remove User</button>
    </form>

    <h2>Change User Role</h2>
    <form method="POST" action="{{ url_for('change_role') }}">
      <label for="user_id">Select User:</label>
      <select name="user_id">
        {% for u in users %}
          <option value="{{ u.id }}">{{ u.name }} ({{ u.role }})</option>
        {% endfor %}
      </select>

      <label for="new_role">New Role:</label>
      <select name="new_role">
        <option value="student">Student</option>
        <option value="mentor">Mentor</option>
        <option value="admin">Admin</option>
      </select>

      <button type="submit" class="btn">Change Role</button>
    </form>

    <a href="{{ url_for('logout') }}" class="btn logout-btn">Logout</a>
  </div>
</body>
</html>
